name: Run accessibility tests on JupyterLab

on: [workflow_dispatch, push, pull_request]

defaults:
  run:
    working-directory: ./testing/jupyterlab

jobs:
  a11y-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository 🛎
        uses: actions/checkout@v3

      - name: Set up Python 🐍
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Set up Node 🧶
        uses: actions/setup-node@v3
        with:
          node-version: "14.x"

      - name: Cache conda 🧠
        uses: actions/cache@v2
        env:
          # Increase this value to reset cache if etc/example-environment.yml has not changed
          CACHE_NUMBER: 0
        with:
          path: ~/conda_pkgs_dir
          key: ${{ runner.os }}-conda-${{ env.CACHE_NUMBER }}-${{
            hashFiles('environment.yml') }}

      - name: Install miniconda 🐍
        uses: conda-incubator/setup-miniconda@v2
        with:
          environment-file: environment.yml
          miniforge-version: latest
          activate-environment: a11y-tests

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"

      - name: Cache yarn 🧠
        uses: actions/cache@v2
        id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install node dependencies 🧶
        run: |
          yarn install
          npx playwright install

      - name: Run tests  ✅
        run: yarn test

      - name: Upload testing results 📤
        uses: actions/upload-artifact@v3
        # using default retention policy = 90 days
        with:
          name: jupyterlab-a11-tests
          path: |
            jupyter-ally-build/jupyter-axe/test-results/*.html
            jupyter-ally-build/jupyter-axe/test-results/**/*.html
            jupyter-ally-build/jupyter-axe/test-results/*.json
            jupyter-ally-build/jupyter-axe/test-results/**/*.json
